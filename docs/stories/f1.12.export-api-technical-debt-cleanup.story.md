# Story F1.12: Export API Technical Debt Cleanup

**Status:** In Progress

**Epic:** Epic F1: Web Frontend Implementation (Technical Debt)

## User Story

As a developer,
I want to clean up technical debt in the export API,
so that the codebase is more maintainable, secure, and performant.

## Acceptance Criteria

1.12.1: Critical PDF Content-Length header bug fixed
1.12.2: CSV row generation logic bug fixed
1.12.3: PDF generator extracted to separate testable module
1.12.4: Export configuration file created with all constants
1.12.5: CSV streaming implemented for memory efficiency
1.12.6: Export limits and validation added
1.12.7: Filename generation properly sanitized
1.12.8: Error handling improved with proper logging
1.12.9: Result transformation logic extracted to reusable utility
1.12.10: Unit tests added for export functionality

**Integration Verification:**
IV1: All export formats (PDF, CSV) work correctly
IV2: Large dataset exports don't cause memory issues
IV3: Error responses are safe and informative
IV4: Export limits prevent system overload

## Dev Notes

### Previous Story Insights
Story F1.10 completed theme toggle fixes. The export API in routes/export.js has accumulated significant technical debt including critical bugs, monolithic functions, missing validation, and poor error handling that needs immediate attention for production stability.

### Data Models

**Export Request Schema:**
```typescript
interface ExportRequest {
  jobId: string;
  format: 'pdf' | 'csv';
  template?: 'standard' | 'detailed' | 'summary';
}

interface ExportLimits {
  maxRecords: number;
  pdfMaxInvoices: number;
  csvMaxRecords: number;
}
```

**PDF Generation Config:**
```typescript
interface PDFConfig {
  pageSize: [number, number];
  margins: {
    top: number;
    bottom: number;
    left: number;
    right: number;
  };
  colors: {
    primary: string;
    secondary: string;
    accent: string;
  };
  fonts: {
    header: string;
    body: string;
  };
}
```

### API Specifications

**Export Endpoint (Existing - To be Enhanced):**
```
GET /api/export/:jobId/:format/:template?
Response: File download (PDF/CSV) or JSON error
Headers:
  - Content-Type: application/pdf or text/csv
  - Content-Disposition: attachment; filename="..."
  - Content-Length: <calculated correctly>
  - X-Export-Limit-Warning: <warning if approaching limits>
```

**Error Response Format:**
```typescript
interface ExportError {
  error: string;
  message: string;
  errorCode: string;
  details?: {
    maxAllowed?: number;
    currentCount?: number;
  };
}
```

### Component Specifications

**No new UI components required for this technical debt cleanup**

### File Locations

**Core Export Files:**
```
src/api/export.js                              # Main export logic (to be refactored)
utils/pdf-report-generator.js                  # New: PDF generation module
utils/result-transformer.js                    # New: Result transformation utility
config/export.config.js                        # New: Export configuration
tests/export.test.js                           # New: Export unit tests
tests/pdf-report-generator.test.js             # New: PDF generator tests
```

**Related Files:**
```
src/api/results.js                             # Uses similar transformation logic
package.json                                   # Add csv-stringify dependency
```

### Testing Requirements

**Unit Tests:** Test export logic, PDF generation, and validation
**Integration Tests:** Test full export workflows with various data sizes
**Performance Tests:** Verify memory usage with large datasets

**Test Coverage Requirements:**
- Parameter validation and sanitization
- Export limits enforcement
- CSV streaming functionality
- PDF generation for all templates
- Error handling scenarios
- Filename sanitization edge cases

### Technical Constraints

**Framework:** Node.js 18+, Express.js, pdfkit, csv-stringify
**Memory:** Must handle large datasets without memory leaks
**Security:** Sanitize all user inputs, don't leak internal errors
**Performance:** Export time <30s for 1000 records, <5min for 5000 records
**File Formats:** Maintain backward compatibility for PDF/CSV structure

**Performance Requirements:**
- Memory usage: <500MB for 5000 record exports
- Response time: <2s for small exports, <30s for large exports
- Streaming: No buffering of entire CSV in memory
- Error handling: <1s error response time

**Coding Standards:**
- ESLint compliance (existing)
- JSDoc documentation for all exported functions
- Proper error handling with try/catch
- Input validation for all parameters

## Tasks / Subtasks

### Task 1: Critical Bug Fixes (AC: 1.12.1, 1.12.2)
- [ ] 1.1. Fix PDF Content-Length header calculation (line ~215)
- [ ] 1.2. Fix CSV row generation logic (line ~173)
- [ ] 1.3. Test bug fixes don't break existing functionality

### Task 2: Extract PDF Generator Module (AC: 1.12.3)
- [ ] 2.1. Create utils/pdf-report-generator.js with PDFReportGenerator class
- [ ] 2.2. Move PDF generation logic from export.js (lines 230-540+)
- [ ] 2.3. Split into methods: generateReport, addSummarySection, addInvoiceTable, etc.
- [ ] 2.4. Add comprehensive error handling and input validation
- [ ] 2.5. Create unit tests for PDF generator
- [ ] 2.6. Update export.js to use new PDF generator module

### Task 3: Create Export Configuration (AC: 1.12.4)
- [ ] 3.1. Create config/export.config.js with all constants
- [ ] 3.2. Define export limits (maxRecords: 5000, pdfMax: 500)
- [ ] 3.3. Add PDF layout constants (pageSize, margins, colors, fonts)
- [ ] 3.4. Define CSV headers and valid formats/templates
- [ ] 3.5. Update export.js to use configuration file

### Task 4: Implement CSV Streaming (AC: 1.12.5)
- [ ] 4.1. Add csv-stringify to package.json dependencies
- [ ] 4.2. Replace manual CSV generation with streaming pipeline
- [ ] 4.3. Implement stream.pipeline() for proper error handling
- [ ] 4.4. Test streaming with large datasets (1000+ records)
- [ ] 4.5. Verify memory usage improvements

### Task 5: Add Export Validation (AC: 1.12.6)
- [ ] 5.1. Add validation for record count limits
- [ ] 5.2. Implement PDF-specific invoice limits
- [ ] 5.3. Return 413 Payload Too Large for oversized requests
- [ ] 5.4. Add warning headers for approaching limits
- [ ] 5.5. Update API documentation with new limits

### Task 6: Security and Sanitization (AC: 1.12.7)
- [ ] 6.1. Sanitize jobId in filename generation (line ~129)
- [ ] 6.2. Add comprehensive input validation for all parameters
- [ ] 6.3. Test filename sanitization with edge cases
- [ ] 6.4. Verify no path traversal vulnerabilities

### Task 7: Improve Error Handling (AC: 1.12.8)
- [ ] 7.1. Implement proper error logging with structured data
- [ ] 7.2. Create safe error responses for client consumption
- [ ] 7.3. Add specific error codes for different failure types
- [ ] 7.4. Test error scenarios and response formats

### Task 8: Extract Result Transformer (AC: 1.12.9)
- [ ] 8.1. Create utils/result-transformer.js with transformResultsForExport
- [ ] 8.2. Move transformation logic from export.js (lines 50-91)
- [ ] 8.3. Update both export.js and results.js to use shared utility
- [ ] 8.4. Add unit tests for transformation logic

### Task 9: Add Unit Tests (AC: 1.12.10)
- [ ] 9.1. Create tests/export.test.js for main export logic
- [ ] 9.2. Create tests/pdf-report-generator.test.js for PDF generation
- [ ] 9.3. Test parameter validation, limits, and error handling
- [ ] 9.4. Add performance tests for large dataset handling

### Task 10: Integration and Deployment (AC: All, IV1-IV4)
- [ ] 10.1. Test all export formats work correctly
- [ ] 10.2. Verify large dataset exports don't cause memory issues
- [ ] 10.3. Test error responses are safe and informative
- [ ] 10.4. Confirm export limits prevent system overload
- [ ] 10.5. Update API documentation with changes
- [ ] 10.6. Add monitoring for export failures and performance

## Definition of Done

- [ ] Critical PDF Content-Length header bug fixed
- [ ] CSV row generation logic bug fixed
- [ ] PDF generator extracted to separate testable module
- [ ] Export configuration file created with all constants
- [ ] CSV streaming implemented for memory efficiency
- [ ] Export limits and validation added
- [ ] Filename generation properly sanitized
- [ ] Error handling improved with proper logging
- [ ] Result transformation logic extracted to reusable utility
- [ ] Unit tests added for export functionality
- [ ] All export formats work correctly
- [ ] Large dataset exports don't cause memory issues
- [ ] Error responses are safe and informative
- [ ] Export limits prevent system overload
- [ ] Code follows existing patterns and standards
- [ ] Code review completed by another developer
- [ ] QA verification of export functionality

## Project Structure Notes

Export API technical debt cleanup addresses critical production issues while improving maintainability. The refactoring extracts monolithic functions into testable modules and adds proper validation, error handling, and security measures. Changes maintain backward compatibility while significantly improving reliability and performance.

## Testing

### Testing Standards
- Unit tests in `tests/export.test.js` and `tests/pdf-report-generator.test.js`
- Integration tests for full export workflows
- Performance tests for memory usage and response times
- Security tests for input validation and sanitization

### Specific Testing Requirements
- Test all export formats (PDF, CSV) with various templates
- Verify export limits are enforced correctly
- Test streaming CSV generation with large datasets
- Ensure error messages are safe and don't leak internal information
- Test filename sanitization prevents path traversal
- Verify PDF generation works for all supported templates
- Test transformation logic produces consistent results

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-12-08 | v1.0 | Initial export API technical debt cleanup story | Scrum Master (Bob) |

## Dev Agent Record

**Agent Model Used:** [To be populated by Dev Agent]

**Debug Log References:** [To be populated by Dev Agent]

**Completion Notes:** [To be populated by Dev Agent]

**File List:** [To be populated by Dev Agent]

## QA Results

**Status:** [To be populated by QA Agent]

**Assessment Summary:** [To be populated by QA Agent]

**Issues Found:** [To be populated by QA Agent]

**Recommendations:** [To be populated by QA Agent]