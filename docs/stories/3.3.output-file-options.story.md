# Story 3.3: Output File Options

**Status:** Completed

**Epic:** Epic 3: Batch Processing & CLI

## User Story

As a user,
I want flexible output options for processed data,
so that I can direct output to files or integrate with other tools.

## Acceptance Criteria

1. `--output <file>` option for single files
2. `--output-dir <directory>` for batch operations
3. `--format json|csv` options
4. Overwrite protection and backup options

## Dev Notes

### Previous Story Insights
Stories 3.1 and 3.2 established CLI functionality for single file and directory batch processing. The commander.js framework supports basic output options. This story focuses on comprehensive output flexibility including file destinations, format options, and data safety features.

### Data Models
Flexible output requires format conversion and file management:
- Multiple output format support (JSON, CSV)
- File path generation and validation
- Overwrite protection and backup creation
- Output directory structure management
- Format-specific data transformation

[Source: docs/architecture/backend-architecture.md#api-design]

### API Specifications
Extend CLI with comprehensive output options:
- Output file specification with path validation
- Output directory specification for batch operations
- Format selection (JSON, CSV) with appropriate conversions
- Overwrite protection with backup file creation
- Output naming conventions and conflict resolution

### Component Specifications
Implement output format conversion and file management. Add CSV export functionality, file naming logic, and overwrite protection while maintaining JSON output compatibility.

### File Locations
Core implementation extends index.js with output formatting and file management logic. No additional files required - output functionality integrates with existing CLI framework.

[Source: docs/architecture/backend-architecture.md#technology-stack]

### Testing Requirements
Output options testing requires file system validation and format verification. Test file creation, format conversion, overwrite protection, and directory structure management.

[Source: docs/architecture/quality-assurance-architecture.md#testing-strategy]

### Technical Constraints
- Maintain backward compatibility with existing output
- Use standard CSV format for spreadsheet compatibility
- Implement safe file operations with backup creation
- Handle file system permissions and path validation
- Keep output format conversion efficient

[Source: docs/architecture/backend-architecture.md#technology-stack]

## Tasks / Subtasks

### Task 1: Single File Output Option [AC1]
- Implement `--output <file>` CLI option
- Add file path validation and directory creation
- Integrate with single file processing output
- Test file output functionality

### Task 2: Batch Directory Output [AC2]
- Implement `--output-dir <directory>` for batch operations
- Create output directory structure management
- Generate appropriate file names for batch output
- Test directory output with multiple files

### Task 3: CSV Format Support [AC3]
- Implement CSV format conversion from JSON data
- Create CSV headers and data mapping
- Handle nested JSON structures appropriately
- Test CSV output formatting and compatibility

### Task 4: Overwrite Protection [AC4]
- Implement overwrite detection and user confirmation
- Add backup file creation for existing files
- Provide overwrite protection options (--force, --backup)
- Test overwrite protection mechanisms

### Task 5: Output Integration and Validation
- Integrate all output options with CLI framework
- Test format conversion accuracy
- Validate file system operations
- Ensure backward compatibility

### Task 6: Output Options Testing
- Test complete output functionality across all options
- Validate CSV and JSON format accuracy
- Test overwrite protection and backup creation
- Performance testing with various output scenarios

## Testing

### Unit Testing Requirements
- Output format conversion tests
- File path validation and creation tests
- Overwrite protection tests
- CSV formatting tests

### Integration Testing Requirements
- End-to-end output option testing
- File system integration tests
- Format compatibility testing
- Large batch output testing

### Test Data
- Various JSON data structures for format testing
- Existing files for overwrite protection testing
- Different output directory scenarios
- Large datasets for performance testing

## Dev Agent Record

**Agent Model Used:** Dev Agent

### Tasks / Subtasks Checkboxes
- [x] Task 1: Single File Output Option [AC1] - `--output <file>` option working for parse command
- [x] Task 2: Batch Directory Output [AC2] - `--output-dir <directory>` working for batch command
- [x] Task 3: CSV Format Support [AC3] - CSV conversion implemented with proper escaping
- [x] Task 4: Overwrite Protection [AC4] - Safe file writing with backup and overwrite options
- [x] Task 5: Output Integration and Validation - All output options integrated and tested
- [x] Task 6: Output Options Testing - Comprehensive testing completed for all scenarios

### Debug Log References
- Implemented CSV format conversion with proper comma escaping and quote handling
- Added safeWriteFile utility with overwrite protection and backup creation
- Enhanced batch processing to support individual file output to directories
- Updated parse command with output directory option for single files
- Maintained backward compatibility with existing CLI options

### Completion Notes
- Successfully implemented comprehensive output file options as specified in ACs
- CSV format conversion handles complex invoice data with proper escaping
- Overwrite protection prevents accidental file loss with backup option
- Output directory functionality works for both single files and batch processing
- All acceptance criteria validated through comprehensive testing
- Backward compatibility maintained with existing functionality

### File List
**Source Files:**
- index.js (modified: added CSV conversion, safe file writing, output directory support)

**Test Files:**
- Comprehensive CLI testing with all output option combinations
- File overwrite protection testing with backup functionality
- Output directory creation and file naming validation

## Change Log
- 2025-12-07: Initial story creation for output file options in Epic 3
- 2025-12-07: Implemented CSV format conversion with proper data flattening
- 2025-12-07: Added overwrite protection and backup functionality
- 2025-12-07: Integrated output directory support for batch and single file processing
- 2025-12-07: All acceptance criteria validated and tested successfully