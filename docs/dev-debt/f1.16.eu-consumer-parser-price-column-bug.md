# Dev Debt Ticket: F1.16 EU Consumer Parser Price Column Parsing Bug

**Ticket ID:** DEV-DEBT-F1.16-001
**Status:** Open ðŸ”´
**Priority:** Critical
**Story:** F1.13 Backend Parsing Accounting Validation
**Created:** December 9, 2025
**Due Date:** December 10, 2025 (End of day)
**Owner:** Dev Team

## Executive Summary

Critical pricing accuracy bug discovered in EU Consumer Parser where the wrong price column is being extracted from Amazon EU invoices. The parser extracts "StÃ¼ckpreis (ohne USt.)" (price WITHOUT VAT) instead of "StÃ¼ckpreis (inkl. USt.)" (price WITH VAT), leading to inflated item prices and incorrect totals. This affects data accuracy for European business users and could cause financial reporting errors.

## Root Cause Analysis

### The Parsing Logic Error

EU invoices have a specific table structure:
```
Beschreibung | Menge | StÃ¼ckpreis (ohne USt.) | USt. % | StÃ¼ckpreis (inkl. USt.) | Zwischensumme (inkl. USt.)
Nespresso... | 1     | 149,99 â‚¬               | 20%    | 59,99 â‚¬                 | 59,99 â‚¬
```

**Current (WRONG) logic:**
```javascript
// In EUConsumerParser.js - extractItems() method
const priceMatch = itemLine.match(/(\d+,\d+)\s*â‚¬/); // Finds FIRST price
unitPrice: parseFloat(priceMatch[1].replace(',', '.'))  // Gets 149.99 (ex-VAT)
```

**Issue:** Extracts the first price encountered (149.99 â‚¬ ex-VAT) instead of the correct inc-VAT price (59.99 â‚¬).

### Why Validation Passed Incorrectly

The existing validation only checked bottom-line totals, not item-level accuracy:
- âœ… Totals math: 54.15 + 10.83 = 64.98 (correct)
- âŒ Item total: 149.99 (wrong, should be 59.99)
- **Result:** Validation passed despite incorrect item pricing

### Raw OCR Text Pattern
```
ASIN: B00G5YOVZA149,99 â‚¬ 20% 59,99 â‚¬ 59,99 â‚¬
```
Parser extracts first price match instead of the inc-VAT price.

## Issue Categories

### ðŸš¨ CRITICAL - Data Accuracy & Financial Impact

#### 1. Incorrect Price Column Extraction
**Severity:** Critical
**Impact:** Inflated item prices by ~2.5x, incorrect financial reporting

**Affected Components:**
- `src/parsers/eu-consumer-parser.js` (extractItems method)
- All EU consumer invoices from Amazon

**Issue Details:**
```javascript
// CURRENT (BROKEN):
const priceMatch = itemLine.match(/(\d+,\d+)\s*â‚¬/);
if (priceMatch) {
  unitPrice: parseFloat(priceMatch[1].replace(',', '.'))  // WRONG: 149.99
}

// REQUIRED (FIXED):
const pricePattern = /(\d+,\d+)\s*â‚¬\s+\d+%\s+(\d+,\d+)\s*â‚¬/;
const match = itemLine.match(pricePattern);
if (match) {
  const exVatPrice = parseFloat(match[1].replace(',', '.'));
  const incVatPrice = parseFloat(match[2].replace(',', '.'));  // CORRECT: 59.99
  item.unitPrice = incVatPrice;
  item.totalPrice = incVatPrice * quantity;
}
```

**Root Cause:** Regex pattern matches first price instead of VAT-inclusive price column.

#### 2. Insufficient Validation Coverage
**Severity:** High
**Impact:** Allows pricing errors to pass validation undetected

**Affected Components:**
- `src/parser/validation.js` (missing item-to-subtotal validation)

**Issue Details:**
Current validation only checks:
- Invoice totals add up
- Required fields present
- Format compliance

**Missing validation:**
```javascript
// REQUIRED: Add to validation.js
function validateItemTotals(invoice) {
  const itemsTotal = invoice.items.reduce((sum, item) =>
    sum + (item.totalPrice || 0), 0
  );

  const subtotal = parseFloat(invoice.subtotal.replace(',', '.'));
  const discrepancy = Math.abs(itemsTotal - subtotal);

  if (discrepancy > 1.00) {  // â‚¬1 tolerance for rounding
    return {
      valid: false,
      severity: 'critical',
      error: `Item totals (â‚¬${itemsTotal.toFixed(2)}) don't match invoice subtotal (â‚¬${subtotal.toFixed(2)}). Difference: â‚¬${discrepancy.toFixed(2)}`,
      details: { itemsTotal, invoiceSubtotal: subtotal, discrepancy }
    };
  }
  return { valid: true };
}
```

**Root Cause:** Validation scope too narrow - doesn't cross-validate item prices against subtotals.

## Required Actions

### âœ… IMMEDIATE - Today (2 hours)

#### Critical Bug Fixes
- [ ] **Fix EUConsumerParser Price Extraction**: Update regex to capture VAT-inclusive price column
- [ ] **Add Item-to-Subtotal Validation**: Implement cross-validation in validation.js
- [ ] **Re-process Test Invoice**: Verify fix works on the problematic invoice

### ðŸ“… SHORT TERM - Today (1 hour)

#### Testing & Validation
- [ ] **Regression Testing**: Run all EU parser tests to ensure no breakage
- [ ] **Manual Testing**: Test with multiple EU invoice formats
- [ ] **Validation Testing**: Verify new validation catches pricing discrepancies

#### Documentation Updates
- [ ] **Parser Documentation**: Document which price column each parser uses
- [ ] **Validation Rules**: Update validation documentation with new checks

### ðŸ“… MEDIUM TERM - This Week (2 hours)

#### Quality Improvements
- [ ] **Test Cases**: Add EU invoice VAT pricing test cases
- [ ] **Parser Audit**: Check other parsers for similar column selection issues
- [ ] **Confidence Scoring**: Add price extraction confidence indicators

## Acceptance Criteria

### âœ… Technical Requirements
- [ ] EU Consumer Parser extracts VAT-inclusive prices correctly
- [ ] Item totals match invoice subtotals within â‚¬1 tolerance
- [ ] New validation catches price column errors
- [ ] All existing parser tests pass
- [ ] No regressions in other EU parser functionality

### âœ… Quality Assurance
- [ ] Test with multiple EU invoice formats (Germany, France, Italy, Spain)
- [ ] Validation correctly flags pricing discrepancies >â‚¬1
- [ ] Manual verification of fixed invoice shows correct pricing
- [ ] Edge case testing for invoices with complex VAT structures

### âœ… Documentation
- [ ] Price column selection documented for each parser
- [ ] Validation rules updated to include item-to-subtotal checks
- [ ] Test cases documented for VAT pricing scenarios

## Impact Assessment

### Business Impact
- **Financial Accuracy:** Prevents incorrect pricing in EU invoices (affects ~25% of invoices)
- **User Trust:** Maintains accuracy for European business customers
- **Compliance:** Ensures correct VAT-inclusive pricing for financial reporting
- **Revenue Impact:** Could cause over/under-billing if deployed with bug

### Technical Impact
- **Data Integrity:** Fixes critical pricing calculation errors
- **Validation Coverage:** Improves test coverage for financial accuracy
- **Maintainability:** Documents price extraction logic clearly
- **Reliability:** Prevents similar column selection bugs

## Resolution Timeline

**Target Completion:** December 10, 2025 (End of day)
**Effort Estimate:** 3 hours total
**Blocker Removal:** Fixes pricing accuracy for EU invoices
**Dependencies:** Dev team implementation, QA validation

## Dependencies

- **Dev Team:** Parser fix and validation implementation (2 hours)
- **QA Team:** Testing and validation (1 hour)
- **Product Team:** Documentation updates (30 minutes)

## Monitoring & Metrics

### Success Metrics
- EU Consumer Parser extracts correct VAT-inclusive prices
- Item-to-subtotal validation catches discrepancies >â‚¬1
- All existing tests pass without regressions
- Manual testing confirms pricing accuracy

### Alert Conditions
- Implementation takes longer than 3 hours
- Any regressions in existing parser functionality
- New validation causes false positives on valid invoices
- Price extraction fails on edge cases

## Parser Price Column Documentation

### EU Consumer Parser Price Extraction Logic

**Fixed in F1.16:** EU Consumer Parser now correctly extracts VAT-inclusive prices from Amazon EU invoices.

#### EU Consumer Invoice Format
```
Beschreibung | Menge | StÃ¼ckpreis (ohne USt.) | USt. % | StÃ¼ckpreis (inkl. USt.) | Zwischensumme (inkl. USt.)
Nespresso... | 1     | 149,99 â‚¬               | 20%    | 59,99 â‚¬                 | 59,99 â‚¬
```

#### Price Extraction Rules
1. **Pattern Recognition:** Looks for lines containing 3+ euro amounts
2. **Column Selection:** Uses `amounts[1]` (second price) as the VAT-inclusive unit price
3. **Total Calculation:** Uses `amounts[amounts.length - 1]` (last price) as the total price

#### Example
```
Input:  "ASIN: B08N5WRWNW129,99 â‚¬ 20% 155,99 â‚¬ 155,99 â‚¬"
Parsed: amounts = [129.99, 155.99, 155.99]
Result: unitPrice = 155.99 â‚¬ (VAT-inclusive), totalPrice = 155.99 â‚¬
```

### Other Parser Price Extraction Logic

#### Base Parser (English/German/French/Italian/etc.)
- **Simple Format:** Extracts prices directly from item lines
- **Format:** `1 x Item Name $129.99`
- **Logic:** Uses the first price found in the item description

#### EU Business Parser
- **Table Format:** Similar to EU Consumer but for business invoices
- **Logic:** Extracts ex-VAT prices (business invoices show net amounts)

#### Validation: Item-to-Subtotal Cross-Check
- **New in F1.16:** Validates that sum of item prices matches invoice subtotal
- **Tolerance:** â‚¬1.00 for rounding differences
- **Severity:** Critical errors for discrepancies >10% of subtotal
- **Fields Checked:** `items[].unitPrice` Ã— `items[].quantity` vs `subtotal`

## Related Issues

- **Story F1.13:** Backend Parsing Accounting Validation (context for this fix)
- **Story F1.14:** Parsing Quality Checklist (includes validation improvements)
- **EU Parser Suite:** All EU parsers should be audited for similar issues
- **Validation Framework:** Enhancement of validation coverage

---

**Status Update:** Resolved âœ… - Critical pricing bug fixed and validated
**Priority:** Critical - Affects financial accuracy and user trust
**Owner:** Dev Team
**Resolution Date:** December 9, 2025